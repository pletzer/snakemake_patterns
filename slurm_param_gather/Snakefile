
import random

# Number of parallel prep tasks â€” change this easily!
N = 10

localrules: final  # ensures final always runs interactively

rule all:
    input:
        "final.txt"

rule prep:
    output:
        "prep{idx}.txt"
    params:
        sleep_time=lambda wildcards: random.randint(1, 10)
    shell:
        """
        echo "Running {wildcards.idx}, sleeping {params.sleep_time}s"
        sleep {params.sleep_time}
        echo "Output from prep{wildcards.idx}" > {output}
        """

rule final:
    input:
        expand("prep{idx}.txt", idx=range(N))
    output:
        "final.txt"
    
    run:
        # run expects Python code. do not use quotes here
        print("Running final task interactively...")
        with open(output[0], 'w') as f:
            for infile in input:
                with open(infile) as inf:
                    f.write(inf.read())
        print(f"All prep tasks complete. Final result written to {output[0]}")
